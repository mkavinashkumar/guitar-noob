<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scale Machine - Guitar Machines</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <nav>
            <a href="index.html" class="logo">QFGM</a>
            <div class="nav-links">
                <a href="note-machine.html">Note Machine</a>
                <a href="scale-machine.html" class="active">Scale Machine</a>
            </div>
        </nav>
    </header>

    <main>
        <h1>Scale Machine</h1>
        <p>Learn scales across the fretboard with CAGED positions.</p>

        <div class="controls">
            <div class="control-group">
                <label>Key</label>
                <select id="keySelect">
                    <option value="C">C</option>
                    <option value="C#">C# / Db</option>
                    <option value="D">D</option>
                    <option value="D#">D# / Eb</option>
                    <option value="E">E</option>
                    <option value="F">F</option>
                    <option value="F#">F# / Gb</option>
                    <option value="G" selected>G</option>
                    <option value="G#">G# / Ab</option>
                    <option value="A">A</option>
                    <option value="A#">A# / Bb</option>
                    <option value="B">B</option>
                </select>
            </div>

            <div class="control-group">
                <label>Scale Type</label>
                <select id="scaleSelect">
                    <option value="major">Major</option>
                    <option value="minor">Natural Minor</option>
                    <option value="majorPentatonic">Major Pentatonic</option>
                    <option value="minorPentatonic" selected>Minor Pentatonic</option>
                    <option value="harmonicMinor">Harmonic Minor</option>
                    <option value="melodicMinor">Melodic Minor</option>
                    <option value="dorian">Dorian</option>
                    <option value="phrygian">Phrygian</option>
                    <option value="lydian">Lydian</option>
                    <option value="mixolydian">Mixolydian</option>
                    <option value="locrian">Locrian</option>
                    <option value="blues">Blues</option>
                </select>
            </div>

            <div class="control-group">
                <label>CAGED Position</label>
                <div class="caged-selector">
                    <button class="caged-btn active" data-caged="all">All</button>
                    <button class="caged-btn" data-caged="C">C</button>
                    <button class="caged-btn" data-caged="A">A</button>
                    <button class="caged-btn" data-caged="G">G</button>
                    <button class="caged-btn" data-caged="E">E</button>
                    <button class="caged-btn" data-caged="D">D</button>
                </div>
            </div>

            <div class="control-group">
                <label>Show Notes</label>
                <select id="showNotes">
                    <option value="none">None</option>
                    <option value="root">Root only</option>
                    <option value="all" selected>All notes</option>
                    <option value="degrees">Scale degrees</option>
                </select>
            </div>
        </div>

        <div class="fretboard-container">
            <div class="fretboard" id="fretboard"></div>
            <div class="fret-markers" id="fretMarkers"></div>
        </div>

        <div class="scale-info">
            <h3 id="scaleTitle">G Minor Pentatonic</h3>
            <p id="scaleNotes">Notes: G - Bb - C - D - F</p>
            <p id="scaleFormula">Formula: 1 - b3 - 4 - 5 - b7</p>
        </div>
    </main>

    <footer>
        <p>A guitar learning tool</p>
    </footer>

    <script>
        // Standard tuning: E A D G B E (low to high, displayed top to bottom)
        const TUNING = ['E', 'B', 'G', 'D', 'A', 'E'];
        const NOTES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const NUM_FRETS = 12;
        const FRET_MARKERS = [3, 5, 7, 9, 12];
        const DOUBLE_MARKERS = [12];

        // Scale intervals (semitones from root)
        const SCALES = {
            major: { intervals: [0, 2, 4, 5, 7, 9, 11], formula: '1 - 2 - 3 - 4 - 5 - 6 - 7' },
            minor: { intervals: [0, 2, 3, 5, 7, 8, 10], formula: '1 - 2 - b3 - 4 - 5 - b6 - b7' },
            majorPentatonic: { intervals: [0, 2, 4, 7, 9], formula: '1 - 2 - 3 - 5 - 6' },
            minorPentatonic: { intervals: [0, 3, 5, 7, 10], formula: '1 - b3 - 4 - 5 - b7' },
            harmonicMinor: { intervals: [0, 2, 3, 5, 7, 8, 11], formula: '1 - 2 - b3 - 4 - 5 - b6 - 7' },
            melodicMinor: { intervals: [0, 2, 3, 5, 7, 9, 11], formula: '1 - 2 - b3 - 4 - 5 - 6 - 7' },
            dorian: { intervals: [0, 2, 3, 5, 7, 9, 10], formula: '1 - 2 - b3 - 4 - 5 - 6 - b7' },
            phrygian: { intervals: [0, 1, 3, 5, 7, 8, 10], formula: '1 - b2 - b3 - 4 - 5 - b6 - b7' },
            lydian: { intervals: [0, 2, 4, 6, 7, 9, 11], formula: '1 - 2 - 3 - #4 - 5 - 6 - 7' },
            mixolydian: { intervals: [0, 2, 4, 5, 7, 9, 10], formula: '1 - 2 - 3 - 4 - 5 - 6 - b7' },
            locrian: { intervals: [0, 1, 3, 5, 6, 8, 10], formula: '1 - b2 - b3 - 4 - b5 - b6 - b7' },
            blues: { intervals: [0, 3, 5, 6, 7, 10], formula: '1 - b3 - 4 - b5 - 5 - b7' }
        };

        // CAGED positions (fret ranges relative to root position)
        // Each position defines a comfortable box pattern
        const CAGED_POSITIONS = {
            'E': { offset: 0, range: 4 },
            'D': { offset: 2, range: 4 },
            'C': { offset: 3, range: 4 },
            'A': { offset: 5, range: 4 },
            'G': { offset: 7, range: 4 }
        };

        let currentCaged = 'all';

        // Get note at position
        function getNoteAt(stringIndex, fret) {
            const openNote = TUNING[stringIndex];
            const openNoteIndex = NOTES.indexOf(openNote);
            const noteIndex = (openNoteIndex + fret) % 12;
            return NOTES[noteIndex];
        }

        // Get note name with preference for flats/sharps based on key
        function getNoteName(noteIndex, key) {
            const note = NOTES[noteIndex % 12];
            // Simple approach - return sharp notation
            return note;
        }

        // Get scale degree name
        function getScaleDegree(interval, scaleType) {
            const degrees = {
                0: '1', 1: 'b2', 2: '2', 3: 'b3', 4: '3', 5: '4',
                6: 'b5', 7: '5', 8: 'b6', 9: '6', 10: 'b7', 11: '7'
            };
            return degrees[interval] || '';
        }

        // Build fretboard
        function buildFretboard() {
            const fretboard = document.getElementById('fretboard');
            const markers = document.getElementById('fretMarkers');
            fretboard.innerHTML = '';
            markers.innerHTML = '';

            for (let s = 0; s < 6; s++) {
                const row = document.createElement('div');
                row.className = 'string-row';

                const label = document.createElement('div');
                label.className = 'string-label';
                label.textContent = TUNING[s];
                row.appendChild(label);

                const frets = document.createElement('div');
                frets.className = 'frets';

                for (let f = 1; f <= NUM_FRETS; f++) {
                    const fret = document.createElement('div');
                    fret.className = 'fret';
                    fret.dataset.string = s;
                    fret.dataset.fret = f;

                    const note = document.createElement('div');
                    note.className = 'fret-note';
                    note.id = `note-${s}-${f}`;
                    fret.appendChild(note);

                    frets.appendChild(fret);
                }

                row.appendChild(frets);
                fretboard.appendChild(row);
            }

            for (let f = 1; f <= NUM_FRETS; f++) {
                const marker = document.createElement('div');
                marker.className = 'fret-marker';
                marker.textContent = f;

                if (DOUBLE_MARKERS.includes(f)) {
                    marker.classList.add('double-dot');
                } else if (FRET_MARKERS.includes(f)) {
                    marker.classList.add('dot');
                }

                markers.appendChild(marker);
            }
        }

        // Find root note positions on fretboard
        function findRootPositions(rootNote) {
            const positions = [];
            for (let s = 0; s < 6; s++) {
                for (let f = 1; f <= NUM_FRETS; f++) {
                    if (getNoteAt(s, f) === rootNote) {
                        positions.push({ string: s, fret: f });
                    }
                }
            }
            return positions;
        }

        // Get CAGED position fret range
        function getCAGEDRange(rootNote, cagedShape) {
            if (cagedShape === 'all') {
                return { min: 0, max: NUM_FRETS };
            }

            // Find the lowest root note on the low E string (or closest)
            const rootIndex = NOTES.indexOf(rootNote);
            const lowEIndex = NOTES.indexOf('E');
            let baseFret = (rootIndex - lowEIndex + 12) % 12;
            if (baseFret === 0) baseFret = 12; // Avoid open position ambiguity

            const position = CAGED_POSITIONS[cagedShape];
            let startFret = baseFret + position.offset - 5;

            // Adjust to keep in reasonable range
            while (startFret < 0) startFret += 12;
            while (startFret > 12) startFret -= 12;

            return {
                min: Math.max(0, startFret - 1),
                max: Math.min(NUM_FRETS, startFret + position.range + 1)
            };
        }

        // Update scale display
        function updateScale() {
            const key = document.getElementById('keySelect').value;
            const scaleType = document.getElementById('scaleSelect').value;
            const showNotes = document.getElementById('showNotes').value;
            const scale = SCALES[scaleType];

            // Clear fretboard
            document.querySelectorAll('.fret-note').forEach(n => {
                n.classList.remove('visible', 'root', 'scale');
                n.textContent = '';
            });

            const rootIndex = NOTES.indexOf(key);
            const scaleNotes = scale.intervals.map(i => NOTES[(rootIndex + i) % 12]);
            const cagedRange = getCAGEDRange(key, currentCaged);

            // Display scale on fretboard
            for (let s = 0; s < 6; s++) {
                for (let f = 1; f <= NUM_FRETS; f++) {
                    // Check CAGED range
                    if (currentCaged !== 'all' && (f < cagedRange.min || f > cagedRange.max)) {
                        continue;
                    }

                    const note = getNoteAt(s, f);
                    const intervalIndex = scaleNotes.indexOf(note);

                    if (intervalIndex !== -1) {
                        const noteEl = document.getElementById(`note-${s}-${f}`);
                        noteEl.classList.add('visible');

                        if (note === key) {
                            noteEl.classList.add('root');
                        } else {
                            noteEl.classList.add('scale');
                        }

                        // Set note text based on display preference
                        if (showNotes === 'all') {
                            noteEl.textContent = note;
                        } else if (showNotes === 'root' && note === key) {
                            noteEl.textContent = note;
                        } else if (showNotes === 'degrees') {
                            noteEl.textContent = getScaleDegree(scale.intervals[intervalIndex], scaleType);
                        }
                    }
                }
            }

            // Update scale info
            const scaleNames = {
                major: 'Major',
                minor: 'Natural Minor',
                majorPentatonic: 'Major Pentatonic',
                minorPentatonic: 'Minor Pentatonic',
                harmonicMinor: 'Harmonic Minor',
                melodicMinor: 'Melodic Minor',
                dorian: 'Dorian',
                phrygian: 'Phrygian',
                lydian: 'Lydian',
                mixolydian: 'Mixolydian',
                locrian: 'Locrian',
                blues: 'Blues'
            };

            document.getElementById('scaleTitle').textContent = `${key} ${scaleNames[scaleType]}`;
            document.getElementById('scaleNotes').textContent = `Notes: ${scaleNotes.join(' - ')}`;
            document.getElementById('scaleFormula').textContent = `Formula: ${scale.formula}`;
        }

        // CAGED button handlers
        document.querySelectorAll('.caged-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.caged-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentCaged = btn.dataset.caged;
                updateScale();
            };
        });

        // Control change handlers
        document.getElementById('keySelect').onchange = updateScale;
        document.getElementById('scaleSelect').onchange = updateScale;
        document.getElementById('showNotes').onchange = updateScale;

        // Initialize
        buildFretboard();
        updateScale();
    </script>
</body>
</html>
